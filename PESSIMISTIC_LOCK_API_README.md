# æ‚²è§‚é”ç¥¨åˆ¸æ›´æ–°æ¥å£è¯´æ˜

## æ¦‚è¿°

æœ¬æ¥å£ä½¿ç”¨æ‚²è§‚é”ï¼ˆPessimistic Lockï¼‰æ¥æ‰¹é‡ä¿®æ”¹3å¤©çš„ç¥¨åˆ¸æ•°é‡ï¼Œç¡®ä¿ç®¡ç†å‘˜æ“ä½œä¸ä¼šå½±å“ç”¨æˆ·æŠ¢ç¥¨çš„å¹¶å‘æƒ…å†µã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ”’ **æ‚²è§‚é”ä¿æŠ¤**
- ä½¿ç”¨ `SELECT ... FOR UPDATE` è·å–è¡Œçº§é”
- é˜²æ­¢å¹¶å‘ä¿®æ”¹åŒä¸€å¼ ç¥¨åˆ¸
- ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### ğŸš€ **å¹¶å‘å®‰å…¨**
- ç®¡ç†å‘˜æ“ä½œä¸ç”¨æˆ·æŠ¢ç¥¨å®Œå…¨éš”ç¦»
- ä½¿ç”¨ç‹¬ç«‹çš„äº‹åŠ¡å¤„ç†
- ä¸å½±å“ç°æœ‰çš„æŠ¢ç¥¨é€»è¾‘

### ğŸ“Š **æ‰¹é‡æ“ä½œ**
- æ”¯æŒä¸€æ¬¡æ€§ä¿®æ”¹å¤šå¤©ç¥¨åˆ¸
- åŸå­æ€§æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
- è¯¦ç»†çš„æ‰§è¡Œç»“æœåé¦ˆ

## API æ¥å£

### æ¥å£åœ°å€
```
POST /api/tickets/admin/updateTicketsWithPessimistic
```

### è¯·æ±‚å‚æ•°
```json
{
    "adminId": "admin",
    "ticketUpdates": [
        {
            "date": "2025-08-11",
            "name": "ä»Šæ—¥ç¥¨åˆ¸",
            "totalCount": 100,
            "remainingCount": 100
        },
        {
            "date": "2025-08-12",
            "name": "æ˜æ—¥ç¥¨åˆ¸",
            "totalCount": 150,
            "remainingCount": 150
        },
        {
            "date": "2025-08-13",
            "name": "åæ—¥ç¥¨åˆ¸",
            "totalCount": 200,
            "remainingCount": 200
        }
    ]
}
```

### å“åº”æ ¼å¼
```json
{
    "success": true,
    "data": {
        "status": "SUCCESS",
        "message": "æ‰¹é‡ä¿®æ”¹å®Œæˆï¼ŒæˆåŠŸ: 3, å¤±è´¥: 0",
        "totalCount": 3,
        "successCount": 3,
        "failCount": 0,
        "updateResults": [
            {
                "date": "2025-08-11",
                "status": "UPDATED",
                "message": "ç¥¨åˆ¸æ›´æ–°æˆåŠŸ",
                "oldTotalCount": 80,
                "newTotalCount": 100,
                "oldRemainingCount": 30,
                "newRemainingCount": 100
            }
        ],
        "timestamp": 1640995200000
    }
}
```

## æŠ€æœ¯å®ç°

### 1. æ‚²è§‚é”æœºåˆ¶
```java
// ä½¿ç”¨ FOR UPDATE è·å–è¡Œçº§é”
TicketEntity ticketEntity = ticketEntityMapper.selectByDateForUpdate(update.getDate());
```

### 2. äº‹åŠ¡ç®¡ç†
```java
@Transactional
public Map<String, Object> updateTicketsWithPessimistic(List<TicketUpdate> ticketUpdates)
```

### 3. ç¼“å­˜åŒæ­¥
```java
// æ›´æ–°Redisç¼“å­˜ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
ticketCacheManager.deleteTicket(update.getDate());
```

## å¹¶å‘å®‰å…¨æ€§åˆ†æ

### ğŸ›¡ï¸ **ç”¨æˆ·æŠ¢ç¥¨ä¸å—å½±å“**

1. **ç‹¬ç«‹çš„é”æœºåˆ¶**
   - ç”¨æˆ·æŠ¢ç¥¨ä½¿ç”¨ä¹è§‚é”ï¼ˆç‰ˆæœ¬æ§åˆ¶ï¼‰
   - ç®¡ç†å‘˜ä¿®æ”¹ä½¿ç”¨æ‚²è§‚é”ï¼ˆè¡Œçº§é”ï¼‰
   - ä¸¤ç§é”æœºåˆ¶äº’ä¸å¹²æ‰°

2. **äº‹åŠ¡éš”ç¦»**
   - ç®¡ç†å‘˜æ“ä½œåœ¨ç‹¬ç«‹äº‹åŠ¡ä¸­æ‰§è¡Œ
   - ç”¨æˆ·æŠ¢ç¥¨åœ¨å¦ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œ
   - äº‹åŠ¡ä¹‹é—´å®Œå…¨éš”ç¦»

3. **é”çš„ç²’åº¦**
   - æ‚²è§‚é”åªé”å®šè¢«ä¿®æ”¹çš„ç¥¨åˆ¸è¡Œ
   - å…¶ä»–ç¥¨åˆ¸ä»ç„¶å¯ä»¥æ­£å¸¸æŠ¢è´­
   - é”çš„æŒæœ‰æ—¶é—´å¾ˆçŸ­

### ğŸ“ˆ **æ€§èƒ½ä¼˜åŒ–**

1. **æ‰¹é‡å¤„ç†**
   - ä¸€æ¬¡è¯·æ±‚å¤„ç†å¤šå¤©ç¥¨åˆ¸
   - å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
   - æé«˜æ•´ä½“æ•ˆç‡

2. **ç¼“å­˜æ›´æ–°**
   - æ‰¹é‡æ›´æ–°Redisç¼“å­˜
   - é¿å…é¢‘ç¹çš„ç¼“å­˜æ“ä½œ
   - ä¿æŒç¼“å­˜ä¸€è‡´æ€§

## ä½¿ç”¨åœºæ™¯

### ğŸ¯ **é€‚ç”¨åœºæ™¯**
- ç®¡ç†å‘˜æ‰¹é‡è°ƒæ•´ç¥¨åˆ¸æ•°é‡
- ç³»ç»Ÿç»´æŠ¤æ—¶æ›´æ–°ç¥¨åˆ¸ä¿¡æ¯
- æ´»åŠ¨é…ç½®æ—¶ä¿®æ”¹ç¥¨åˆ¸å‚æ•°

### âš ï¸ **æ³¨æ„äº‹é¡¹**
- å»ºè®®åœ¨ç”¨æˆ·æŠ¢ç¥¨ä½å³°æœŸæ‰§è¡Œ
- é¿å…é¢‘ç¹ä¿®æ”¹åŒä¸€å¼ ç¥¨åˆ¸
- ç¡®ä¿ç®¡ç†å‘˜æƒé™éªŒè¯

## æµ‹è¯•æ–¹æ³•

### 1. å¯åŠ¨åº”ç”¨
```bash
mvn spring-boot:run
```

### 2. è®¿é—®æµ‹è¯•é¡µé¢
```
http://localhost:8081/admin-ticket-update.html
```

### 3. æµ‹è¯•å¹¶å‘åœºæ™¯
```bash
# åŒæ—¶å¯åŠ¨å¤šä¸ªç”¨æˆ·æŠ¢ç¥¨è¯·æ±‚
curl -X POST http://localhost:8081/api/tickets/purchase \
  -H "Content-Type: application/json" \
  -d '{"userId":"user1","date":"2025-08-11"}'

# åŒæ—¶æ‰§è¡Œç®¡ç†å‘˜ä¿®æ”¹
curl -X POST http://localhost:8081/api/tickets/admin/updateTicketsWithPessimistic \
  -H "Content-Type: application/json" \
  -d '{"adminId":"admin","ticketUpdates":[...]}'
```

## é”™è¯¯å¤„ç†

### ğŸ” **å¸¸è§é”™è¯¯**

1. **æƒé™ä¸è¶³**
   ```
   "æƒé™ä¸è¶³ï¼Œéœ€è¦ç®¡ç†å‘˜æƒé™"
   ```

2. **å‚æ•°éªŒè¯å¤±è´¥**
   ```
   "è¯·æ±‚å‚æ•°ä¸èƒ½ä¸ºç©º"
   ```

3. **æ•°æ®åº“æ“ä½œå¤±è´¥**
   ```
   "ç¥¨åˆ¸æ›´æ–°å¤±è´¥"
   ```

### ğŸ› ï¸ **æ•…éšœæ’é™¤**

1. **æ£€æŸ¥ç®¡ç†å‘˜ID**
   - ç¡®ä¿ `adminId` ä¸º "admin"

2. **éªŒè¯è¯·æ±‚å‚æ•°**
   - æ£€æŸ¥æ—¥æœŸæ ¼å¼ï¼ˆYYYY-MM-DDï¼‰
   - ç¡®ä¿ç¥¨æ•°ä¸ºæ­£æ•´æ•°

3. **æŸ¥çœ‹æ—¥å¿—**
   - æ£€æŸ¥åº”ç”¨å¯åŠ¨æ—¥å¿—
   - æŸ¥çœ‹æ•°æ®åº“è¿æ¥çŠ¶æ€

## ç›‘æ§å’Œå‘Šè­¦

### ğŸ“Š **å…³é”®æŒ‡æ ‡**
- æ‰¹é‡æ›´æ–°æˆåŠŸç‡
- å¹³å‡æ‰§è¡Œæ—¶é—´
- å¹¶å‘å†²çªæ¬¡æ•°

### ğŸš¨ **å‘Šè­¦è§„åˆ™**
- æ›´æ–°å¤±è´¥ç‡ > 10%
- æ‰§è¡Œæ—¶é—´ > 5ç§’
- æ•°æ®åº“è¿æ¥å¼‚å¸¸

## æ€»ç»“

è¿™ä¸ªæ‚²è§‚é”æ¥å£æä¾›äº†å®‰å…¨ã€é«˜æ•ˆçš„ç¥¨åˆ¸æ‰¹é‡ä¿®æ”¹åŠŸèƒ½ï¼š

âœ… **å®‰å…¨æ€§**ï¼šä½¿ç”¨æ‚²è§‚é”ç¡®ä¿æ•°æ®ä¸€è‡´æ€§  
âœ… **å¹¶å‘æ€§**ï¼šä¸å½±å“ç”¨æˆ·æŠ¢ç¥¨çš„æ­£å¸¸æµç¨‹  
âœ… **å¯é æ€§**ï¼šäº‹åŠ¡ä¿è¯æ“ä½œçš„åŸå­æ€§  
âœ… **æ˜“ç”¨æ€§**ï¼šæä¾›å‹å¥½çš„Webç•Œé¢å’ŒAPIæ¥å£  

é€šè¿‡åˆç†ä½¿ç”¨è¿™ä¸ªæ¥å£ï¼Œç®¡ç†å‘˜å¯ä»¥åœ¨ä¸å½±å“ç”¨æˆ·ä½“éªŒçš„æƒ…å†µä¸‹ï¼Œçµæ´»è°ƒæ•´ç¥¨åˆ¸é…ç½®ã€‚
